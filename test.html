<!DOCTYPE html>
<html>
<head>
<title>deferred-generator test</title>
<script src="http://closure-library.googlecode.com/svn/trunk/closure/goog/base.js"></script>
<script src="deferred.js" type="application/javascript;version=1.8"></script>
</head>
<body>
<script>
goog.require('goog.testing.jsunit');
goog.require("goog.testing.AsyncTestCase");
</script>
<script type="application/javascript;version=1.8">
var asyncTestCase = goog.testing.AsyncTestCase.createAndInstall();
asyncTestCase.stepTimeout = 0;

function asyncTimeout(delay) {
	var deferred = new Deferred();
	setTimeout(function () {
		deferred.callback();
	}, delay);
	return deferred;
}

function testDeferredBasic() {
	asyncTestCase.waitForAsync();
	var deferred = new Deferred;
	deferred.then(function (x) {
		assertEquals(42, x);
		asyncTestCase.continueTesting();
	});
	deferred.callback(42);
}

function testDeferredErrback() {
	asyncTestCase.waitForAsync();
	var deferred = new Deferred;
	deferred.then(function (x) {
		assert(false);
	}, function (x) {
		assertEquals(42, x);
		asyncTestCase.continueTesting();
	});
	deferred.errback(42);
}

function testGeneratorTimeout() {
	asyncTestCase.waitForAsync();
	var main = generatorToDeferred(function () {
		var x = 0;
		yield asyncTimeout(1);
		assertEquals(1, ++x);
		yield asyncTimeout(1);
		assertEquals(2, ++x);
		asyncTestCase.continueTesting();
	});

	main();
}

function testGeneratorNested() {
	asyncTestCase.waitForAsync();
	var out = [];
	var a = generatorToDeferred(function () {
		for (var i = 0; i < 3; i ++) {
			out.push("a"+i);
			yield asyncTimeout(1);
		}
	});
	var b = generatorToDeferred(function () {
		for (var i = 0; i < 3; i ++) {
			out.push("b"+i);
			yield asyncTimeout(1);
		}
	});
	var main = generatorToDeferred(function () {
		yield a(asyncTimeout);
		yield b(asyncTimeout);
		assertArrayEquals(["a0", "a1", "a2", "b0", "b1", "b2"], out);
		asyncTestCase.continueTesting();
	});

	main();
}

function testGeneratorThrow() {
	asyncTestCase.waitForAsync();
	var asyncThrow = generatorToDeferred(function (e) {
		yield asyncTimeout(1);
		throw e;
	});
	var main = generatorToDeferred(function () {
		try {
			yield asyncThrow(42);
			assert(false);
		} catch (e) {
			assertEquals(42, e);
		}
		asyncTestCase.continueTesting();
	});
	main();
}

function testGeneratorReturnValue() {
	asyncTestCase.waitForAsync();
	var main = generatorToDeferred(function () {
		yield returnValue(42);
		assert(false);
	});
	main().then(function (x) {
		assertEquals(42, x);
		asyncTestCase.continueTesting();
	});
}
</script>
</body>
</html>
